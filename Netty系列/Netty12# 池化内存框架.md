---

title: Netty12# 池化内存框架
categories: Netty
tags: Netty
date: 2021-02-16 11:55:01

---





# 前言



<!--more-->



# 使用池化内存

**为啥要使用池化内存呢？** 主要以下两点：

1.频繁申请释放堆外直接内存耗时严重影响效率

2.减少小而不连续的空闲内存（也就是内存碎片）



**Netty中又是如何体现内存池并提升效率的呢？** 

1.将申请的大块内存划分为不同的尺寸

2.不同尺寸的内存使用不同的分配算法，例如：Netty参考slab内存分配算法和Buddy（伙伴）分配算法

3.将划分的不同尺寸缓存起来，使用的时候先从缓存中获取

4.每个线程绑定了专属逻辑内存区域（PoolArena），减少资源竞争

5.使用对象池减少频繁创建销毁性能损耗（ByteBuf对象池）

6.内存用完后，按照特定算法重新合并到大块内存中，看起来像是内存池



# 内存池核心组件

**内存池尺寸划分**

Netty内存池划分了四种类型尺寸，Netty以Chunk为单位申请内存，一个Chunk大小为16M。每个Chunk由Page组成，每个Page大小为8KB。 内存池主要指16M（默认）以下的内存，大于16M的内存分配不做缓存。

| 名称   | 范围                                      |
| ------ | ----------------------------------------- |
| tiny   | 0~512Byte，内存分配参考了slab算法         |
| small  | 512Byte~8KB，内存分配同tiny参考了slab算法 |
| normal | 8KB~16M，内存分配参考了                   |
| huge   | 大于16M                                   |



**内存池核心类** 

| 类名                   | 说明                           |
| ---------------------- | ------------------------------ |
| PooledByteBufAllocator | 内存池门面类，池化内存分配入口 |
| PoolArena              | 逻辑上的一块内存区域           |
|                        |                                |
|                        |                                |
|                        |                                |







































