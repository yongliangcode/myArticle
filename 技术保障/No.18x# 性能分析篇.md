```
title: No.182# 故障相关内容提点
categories: 技术保障
tags:技术保障
date: 2023-01-27 11:55:01
```



# 引言





# 一、性能分析简述





性能分析（performance analysis或profiling）是以收集程序运行时信息为手段研究程序行为的分析方法，目的在于程序的哪个部分应该被优化。



性能分析工具（profiler）是一种在应用运行时收集程序相关信息的动态分析手段，帮助分析程序运行行为和性能瓶颈。



由于性能分析工具（perf、SystemTap等）  生成内容不够层次、也不直观、不便于分析和统计，因此常用火焰图来进行分析。



火焰图（Flame Graphs）由Linux性能优化大师Brendan Gregg发明，从宏观角度查看时间花在哪里。火焰图生成的三个步骤：

* 采集堆栈（例如：perf、SystemTap、sample-bt）
* 折叠堆栈（例如：stackcollapse.pl）
* 生成火焰图（例如：flamegraph.pl）



常见火焰图分类

* On-CPU 火焰图 ： CPU占用高的问题
* Off-CPU 火焰图：I/O、网络阻塞、锁竞争、死锁导致的性能下降
* 内存火焰图：申请、释放内存、内存泄漏
* Hot/Cold火焰图：结合On-CPU和Off-CPU的火焰图



| 火焰图类型     | 横轴含义                                         | 纵轴含义 | 解决问题                                                     | 采样方式                                                    |
| :------------- | :----------------------------------------------- | :------- | :----------------------------------------------------------- | :---------------------------------------------------------- |
| On-CPU 火焰图  | cpu占用时间                                      | 调用栈   | 找出 cpu 占用高的问题函数；分析代码热路径                    | 固定频率采样 cpu 调用栈                                     |
| Off-CPU 火焰图 | 阻塞时间                                         | 调用栈   | i/o、网络等阻塞场景导致的性能下降；锁竞争、死锁导致的性能下降问题 | 固定频率采样 阻塞事件调用栈                                 |
| 内存火焰图     | 内存申请/释放函数调用次数                        | 调用栈   | 内存泄露问题；内存占用高的对象/申请内存多的函数；虚拟内存或物理内存泄露问题 | 有四种方式： 跟踪malloc/free；跟踪brk；跟踪mmap；跟踪页错误 |
| Hot/Cold火焰图 | on-CPU 火焰图和 off-CPU 火焰图结合在一起综合展示 | 调用栈   | 需要结合 cpu 占用以及阻塞分析的场景；off-CPU 火焰图无法直观判断问题的场景 | on-CPU 火焰图和 off-CPU 火焰图结合                          |



![image-20230612142204538](/Users/admin/Library/Application Support/typora-user-images/image-20230612142204538.png)



X轴：

* 由多个方块组成、每个方块代表一个函数
* 函数在X轴占用的宽度越宽、表示采样的次数越多、执行时间越长、越可能是瓶颈原因（平顶）

Y轴：

* 表示函数调用栈、调用栈越深、火焰度越高
* 顶部是CPU正在执行的函数、下方均是他的父函数









