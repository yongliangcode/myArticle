service mesh的几个问题：



1.如何将zk等注册中心写入kube-apiserver

 问题：这个负责写入的组件是独立的集群服务还是部署到sidecar中的，如果独立集群部署如何判断写入哪些服务的kube-apiserver呢？



2.istio如何监听的kube-apiserver

问题：这块可以通过读istio源码，暂时先不管



3.istio如何通过xDS推送给数据面

问题：istio如何决定推给哪些数据面呢？服务都是集群部署的。用namespace？感觉不现实。















查询已经存在







登陆容器查询一下系列命令

```
kubectl -n istio-system exec -it istiod-56f8cc6cb5-xkg4m -- /bin/bash
```





```
curl http://127.0.0.1:15014/debug/registryz
```



```
[
    {
        "Attributes": {
            "ServiceRegistry": "External",
            "Name": "org.apache.dubbo.samples.basic.api.testservice",
            "Namespace": "dubbo",
            "Labels": {
                "manager": "aeraki",
                "registry": "dubbo2istio"
            },
            "UID": "",
            "ExportTo": null,
            "LabelSelectors": null,
            "ClusterExternalAddresses": null,
            "ClusterExternalPorts": null
        },
        "ports": [
            {
                "name": "tcp-dubbo",
                "port": 20880,
                "protocol": "TCP"
            }
        ],
        "creationTime": "2021-09-06T07:10:55Z",
        "hostname": "org.apache.dubbo.samples.basic.api.testservice",
        "address": "0.0.0.0",
        "autoAllocatedAddress": "240.240.0.1",
        "Mutex": {},
        "Resolution": 0,
        "MeshExternal": false
    },
    {
        "Attributes": {
            "ServiceRegistry": "External",
            "Name": "org.apache.dubbo.samples.basic.api.complexservice-product-2-0-0",
            "Namespace": "dubbo",
            "Labels": {
                "manager": "aeraki",
                "registry": "dubbo2istio"
            },
            "UID": "",
            "ExportTo": null,
            "LabelSelectors": null,
            "ClusterExternalAddresses": null,
            "ClusterExternalPorts": null
        },
        "ports": [
            {
                "name": "tcp-dubbo",
                "port": 20880,
                "protocol": "TCP"
            }
        ],
        "creationTime": "2021-09-06T07:10:56Z",
        "hostname": "org.apache.dubbo.samples.basic.api.complexservice-product-2-0-0",
        "address": "0.0.0.0",
        "autoAllocatedAddress": "240.240.0.2",
        "Mutex": {},
        "Resolution": 0,
        "MeshExternal": false
    },
    {
        "Attributes": {
            "ServiceRegistry": "External",
            "Name": "org.apache.dubbo.samples.basic.api.complexservice-test-1-0-0",
            "Namespace": "dubbo",
            "Labels": {
                "manager": "aeraki",
                "registry": "dubbo2istio"
            },
            "UID": "",
            "ExportTo": null,
            "LabelSelectors": null,
            "ClusterExternalAddresses": null,
            "ClusterExternalPorts": null
        },
        "ports": [
            {
                "name": "tcp-dubbo",
                "port": 20880,
                "protocol": "TCP"
            }
        ],
        "creationTime": "2021-09-06T07:10:56Z",
        "hostname": "org.apache.dubbo.samples.basic.api.complexservice-test-1-0-0",
        "address": "0.0.0.0",
        "autoAllocatedAddress": "240.240.0.3",
        "Mutex": {},
        "Resolution": 0,
        "MeshExternal": false
    },
    {
        "Attributes": {
            "ServiceRegistry": "External",
            "Name": "org.apache.dubbo.samples.basic.api.demoservice",
            "Namespace": "dubbo",
            "Labels": {
                "manager": "aeraki",
                "registry": "dubbo2istio"
            },
            "UID": "",
            "ExportTo": null,
            "LabelSelectors": null,
            "ClusterExternalAddresses": null,
            "ClusterExternalPorts": null
        },
        "ports": [
            {
                "name": "tcp-dubbo",
                "port": 20880,
                "protocol": "TCP"
            }
        ],
        "creationTime": "2021-09-06T07:10:58Z",
        "hostname": "org.apache.dubbo.samples.basic.api.demoservice",
        "address": "0.0.0.0",
        "autoAllocatedAddress": "240.240.0.4",
        "Mutex": {},
        "Resolution": 0,
        "MeshExternal": false
    },
    {
        "Attributes": {
            "ServiceRegistry": "External",
            "Name": "org.apache.dubbo.demo.demoservice",
            "Namespace": "dubbo",
            "Labels": {
                "manager": "aeraki",
                "registry": "dubbo2istio"
            },
            "UID": "",
            "ExportTo": null,
            "LabelSelectors": null,
            "ClusterExternalAddresses": null,
            "ClusterExternalPorts": null
        },
        "ports": [
            {
                "name": "tcp-dubbo",
                "port": 20880,
                "protocol": "TCP"
            }
        ],
        "creationTime": "2021-09-10T09:58:18Z",
        "hostname": "org.apache.dubbo.demo.demoservice",
        "address": "0.0.0.0",
        "autoAllocatedAddress": "240.240.0.5",
        "Mutex": {},
        "Resolution": 0,
        "MeshExternal": false
    },
    {
        "Attributes": {
            "ServiceRegistry": "Kubernetes",
            "Name": "details",
            "Namespace": "default",
            "Labels": {
                "app": "details",
                "service": "details"
            },
            "UID": "istio://default/services/details",
            "ExportTo": null,
            "LabelSelectors": {
                "app": "details"
            },
            "ClusterExternalAddresses": null,
            "ClusterExternalPorts": null
        },
        "ports": [
            {
                "name": "http",
                "port": 9080,
                "protocol": "HTTP"
            }
        ],
        "creationTime": "2021-08-17T06:37:54Z",
        "hostname": "details.default.svc.cluster.local",
        "address": "10.100.65.41",
        "Mutex": {},
        "cluster-vips": {
            "Kubernetes": "10.100.65.41"
        },
        "Resolution": 0,
        "MeshExternal": false
    },
    {
        "Attributes": {
            "ServiceRegistry": "Kubernetes",
            "Name": "grafana",
            "Namespace": "istio-system",
            "Labels": {
                "app.kubernetes.io/instance": "grafana",
                "app.kubernetes.io/managed-by": "Helm",
                "app.kubernetes.io/name": "grafana",
                "app.kubernetes.io/version": "7.5.5",
                "helm.sh/chart": "grafana-6.11.0"
            },
            "UID": "istio://istio-system/services/grafana",
            "ExportTo": null,
            "LabelSelectors": {
                "app.kubernetes.io/instance": "grafana",
                "app.kubernetes.io/name": "grafana"
            },
            "ClusterExternalAddresses": null,
            "ClusterExternalPorts": null
        },
        "ports": [
            {
                "name": "service",
                "port": 3000,
                "protocol": "UnsupportedProtocol"
            }
        ],
        "creationTime": "2021-08-17T07:02:15Z",
        "hostname": "grafana.istio-system.svc.cluster.local",
        "address": "10.98.153.132",
        "Mutex": {},
        "cluster-vips": {
            "Kubernetes": "10.98.153.132"
        },
        "Resolution": 0,
        "MeshExternal": false
    },
    {
        "Attributes": {
            "ServiceRegistry": "Kubernetes",
            "Name": "istio-ingressgateway",
            "Namespace": "istio-system",
            "Labels": {
                "app": "istio-ingressgateway",
                "install.operator.istio.io/owning-resource": "unknown",
                "install.operator.istio.io/owning-resource-namespace": "istio-system",
                "istio": "ingressgateway",
                "istio.io/rev": "default",
                "operator.istio.io/component": "IngressGateways",
                "operator.istio.io/managed": "Reconcile",
                "operator.istio.io/version": "1.11.0",
                "release": "istio"
            },
            "UID": "istio://istio-system/services/istio-ingressgateway",
            "ExportTo": null,
            "LabelSelectors": {
                "app": "istio-ingressgateway",
                "istio": "ingressgateway"
            },
            "ClusterExternalAddresses": {
                "Kubernetes": [
                    "127.0.0.1"
                ]
            },
            "ClusterExternalPorts": null
        },
        "ports": [
            {
                "name": "status-port",
                "port": 15021,
                "protocol": "UnsupportedProtocol"
            },
            {
                "name": "http2",
                "port": 80,
                "protocol": "HTTP2"
            },
            {
                "name": "https",
                "port": 443,
                "protocol": "HTTPS"
            }
        ],
        "creationTime": "2021-08-17T06:29:04Z",
        "hostname": "istio-ingressgateway.istio-system.svc.cluster.local",
        "address": "10.101.108.23",
        "Mutex": {},
        "cluster-vips": {
            "Kubernetes": "10.101.108.23"
        },
        "Resolution": 0,
        "MeshExternal": false
    },
    {
        "Attributes": {
            "ServiceRegistry": "Kubernetes",
            "Name": "istiod",
            "Namespace": "istio-system",
            "Labels": {
                "app": "istiod",
                "install.operator.istio.io/owning-resource": "unknown",
                "install.operator.istio.io/owning-resource-namespace": "istio-system",
                "istio": "pilot",
                "istio.io/rev": "default",
                "operator.istio.io/component": "Pilot",
                "operator.istio.io/managed": "Reconcile",
                "operator.istio.io/version": "1.11.0",
                "release": "istio"
            },
            "UID": "istio://istio-system/services/istiod",
            "ExportTo": null,
            "LabelSelectors": {
                "app": "istiod",
                "istio": "pilot"
            },
            "ClusterExternalAddresses": null,
            "ClusterExternalPorts": null
        },
        "ports": [
            {
                "name": "grpc-xds",
                "port": 15010,
                "protocol": "GRPC"
            },
            {
                "name": "https-dns",
                "port": 15012,
                "protocol": "HTTPS"
            },
            {
                "name": "https-webhook",
                "port": 443,
                "protocol": "HTTPS"
            },
            {
                "name": "http-monitoring",
                "port": 15014,
                "protocol": "HTTP"
            }
        ],
        "creationTime": "2021-08-17T06:27:39Z",
        "hostname": "istiod.istio-system.svc.cluster.local",
        "address": "10.102.45.128",
        "Mutex": {},
        "cluster-vips": {
            "Kubernetes": "10.102.45.128"
        },
        "Resolution": 0,
        "MeshExternal": false
    },
    {
        "Attributes": {
            "ServiceRegistry": "Kubernetes",
            "Name": "jaeger-collector",
            "Namespace": "istio-system",
            "Labels": {
                "app": "jaeger"
            },
            "UID": "istio://istio-system/services/jaeger-collector",
            "ExportTo": null,
            "LabelSelectors": {
                "app": "jaeger"
            },
            "ClusterExternalAddresses": null,
            "ClusterExternalPorts": null
        },
        "ports": [
            {
                "name": "jaeger-collector-http",
                "port": 14268,
                "protocol": "UnsupportedProtocol"
            },
            {
                "name": "jaeger-collector-grpc",
                "port": 14250,
                "protocol": "UnsupportedProtocol"
            },
            {
                "name": "http-zipkin",
                "port": 9411,
                "protocol": "HTTP"
            }
        ],
        "creationTime": "2021-08-17T07:02:15Z",
        "hostname": "jaeger-collector.istio-system.svc.cluster.local",
        "address": "10.107.97.174",
        "Mutex": {},
        "cluster-vips": {
            "Kubernetes": "10.107.97.174"
        },
        "Resolution": 0,
        "MeshExternal": false
    },
    {
        "Attributes": {
            "ServiceRegistry": "Kubernetes",
            "Name": "kiali",
            "Namespace": "istio-system",
            "Labels": {
                "app": "kiali",
                "app.kubernetes.io/instance": "kiali",
                "app.kubernetes.io/managed-by": "Helm",
                "app.kubernetes.io/name": "kiali",
                "app.kubernetes.io/part-of": "kiali",
                "app.kubernetes.io/version": "v1.38.0",
                "helm.sh/chart": "kiali-server-1.38.0",
                "version": "v1.38.0"
            },
            "UID": "istio://istio-system/services/kiali",
            "ExportTo": null,
            "LabelSelectors": {
                "app.kubernetes.io/instance": "kiali",
                "app.kubernetes.io/name": "kiali"
            },
            "ClusterExternalAddresses": null,
            "ClusterExternalPorts": null
        },
        "ports": [
            {
                "name": "http",
                "port": 20001,
                "protocol": "HTTP"
            },
            {
                "name": "http-metrics",
                "port": 9090,
                "protocol": "HTTP"
            }
        ],
        "creationTime": "2021-08-17T07:02:15Z",
        "hostname": "kiali.istio-system.svc.cluster.local",
        "address": "10.111.179.230",
        "Mutex": {},
        "cluster-vips": {
            "Kubernetes": "10.111.179.230"
        },
        "Resolution": 0,
        "MeshExternal": false
    },
    {
        "Attributes": {
            "ServiceRegistry": "Kubernetes",
            "Name": "kube-dns",
            "Namespace": "kube-system",
            "Labels": {
                "k8s-app": "kube-dns",
                "kubernetes.io/cluster-service": "true",
                "kubernetes.io/name": "CoreDNS"
            },
            "UID": "istio://kube-system/services/kube-dns",
            "ExportTo": null,
            "LabelSelectors": {
                "k8s-app": "kube-dns"
            },
            "ClusterExternalAddresses": null,
            "ClusterExternalPorts": null
        },
        "ports": [
            {
                "name": "dns",
                "port": 53,
                "protocol": "UDP"
            },
            {
                "name": "dns-tcp",
                "port": 53,
                "protocol": "TCP"
            },
            {
                "name": "metrics",
                "port": 9153,
                "protocol": "UnsupportedProtocol"
            }
        ],
        "creationTime": "2021-08-17T03:52:25Z",
        "hostname": "kube-dns.kube-system.svc.cluster.local",
        "address": "10.96.0.10",
        "Mutex": {},
        "cluster-vips": {
            "Kubernetes": "10.96.0.10"
        },
        "Resolution": 0,
        "MeshExternal": false
    },
    {
        "Attributes": {
            "ServiceRegistry": "Kubernetes",
            "Name": "kubernetes",
            "Namespace": "default",
            "Labels": {
                "component": "apiserver",
                "provider": "kubernetes"
            },
            "UID": "istio://default/services/kubernetes",
            "ExportTo": null,
            "LabelSelectors": null,
            "ClusterExternalAddresses": null,
            "ClusterExternalPorts": null
        },
        "ports": [
            {
                "name": "https",
                "port": 443,
                "protocol": "HTTPS"
            }
        ],
        "creationTime": "2021-08-17T03:52:23Z",
        "hostname": "kubernetes.default.svc.cluster.local",
        "address": "10.96.0.1",
        "Mutex": {},
        "cluster-vips": {
            "Kubernetes": "10.96.0.1"
        },
        "Resolution": 0,
        "MeshExternal": false
    },
    {
        "Attributes": {
            "ServiceRegistry": "Kubernetes",
            "Name": "productpage",
            "Namespace": "default",
            "Labels": {
                "app": "productpage",
                "service": "productpage"
            },
            "UID": "istio://default/services/productpage",
            "ExportTo": null,
            "LabelSelectors": {
                "app": "productpage"
            },
            "ClusterExternalAddresses": null,
            "ClusterExternalPorts": null
        },
        "ports": [
            {
                "name": "http",
                "port": 9080,
                "protocol": "HTTP"
            }
        ],
        "creationTime": "2021-08-17T06:37:54Z",
        "hostname": "productpage.default.svc.cluster.local",
        "address": "10.107.21.144",
        "Mutex": {},
        "cluster-vips": {
            "Kubernetes": "10.107.21.144"
        },
        "Resolution": 0,
        "MeshExternal": false
    },
    {
        "Attributes": {
            "ServiceRegistry": "Kubernetes",
            "Name": "prometheus",
            "Namespace": "istio-system",
            "Labels": {
                "app": "prometheus",
                "chart": "prometheus-14.3.0",
                "component": "server",
                "heritage": "Helm",
                "release": "prometheus"
            },
            "UID": "istio://istio-system/services/prometheus",
            "ExportTo": null,
            "LabelSelectors": {
                "app": "prometheus",
                "component": "server",
                "release": "prometheus"
            },
            "ClusterExternalAddresses": null,
            "ClusterExternalPorts": null
        },
        "ports": [
            {
                "name": "http",
                "port": 9090,
                "protocol": "HTTP"
            }
        ],
        "creationTime": "2021-08-17T07:02:16Z",
        "hostname": "prometheus.istio-system.svc.cluster.local",
        "address": "10.105.241.38",
        "Mutex": {},
        "cluster-vips": {
            "Kubernetes": "10.105.241.38"
        },
        "Resolution": 0,
        "MeshExternal": false
    },
    {
        "Attributes": {
            "ServiceRegistry": "Kubernetes",
            "Name": "ratings",
            "Namespace": "default",
            "Labels": {
                "app": "ratings",
                "service": "ratings"
            },
            "UID": "istio://default/services/ratings",
            "ExportTo": null,
            "LabelSelectors": {
                "app": "ratings"
            },
            "ClusterExternalAddresses": null,
            "ClusterExternalPorts": null
        },
        "ports": [
            {
                "name": "http",
                "port": 9080,
                "protocol": "HTTP"
            }
        ],
        "creationTime": "2021-08-17T06:37:54Z",
        "hostname": "ratings.default.svc.cluster.local",
        "address": "10.110.139.187",
        "Mutex": {},
        "cluster-vips": {
            "Kubernetes": "10.110.139.187"
        },
        "Resolution": 0,
        "MeshExternal": false
    },
    {
        "Attributes": {
            "ServiceRegistry": "Kubernetes",
            "Name": "reviews",
            "Namespace": "default",
            "Labels": {
                "app": "reviews",
                "service": "reviews"
            },
            "UID": "istio://default/services/reviews",
            "ExportTo": null,
            "LabelSelectors": {
                "app": "reviews"
            },
            "ClusterExternalAddresses": null,
            "ClusterExternalPorts": null
        },
        "ports": [
            {
                "name": "http",
                "port": 9080,
                "protocol": "HTTP"
            }
        ],
        "creationTime": "2021-08-17T06:37:54Z",
        "hostname": "reviews.default.svc.cluster.local",
        "address": "10.106.238.130",
        "Mutex": {},
        "cluster-vips": {
            "Kubernetes": "10.106.238.130"
        },
        "Resolution": 0,
        "MeshExternal": false
    },
    {
        "Attributes": {
            "ServiceRegistry": "Kubernetes",
            "Name": "tracing",
            "Namespace": "istio-system",
            "Labels": {
                "app": "jaeger"
            },
            "UID": "istio://istio-system/services/tracing",
            "ExportTo": null,
            "LabelSelectors": {
                "app": "jaeger"
            },
            "ClusterExternalAddresses": null,
            "ClusterExternalPorts": null
        },
        "ports": [
            {
                "name": "http-query",
                "port": 80,
                "protocol": "HTTP"
            },
            {
                "name": "grpc-query",
                "port": 16685,
                "protocol": "GRPC"
            }
        ],
        "creationTime": "2021-08-17T07:02:15Z",
        "hostname": "tracing.istio-system.svc.cluster.local",
        "address": "10.104.74.203",
        "Mutex": {},
        "cluster-vips": {
            "Kubernetes": "10.104.74.203"
        },
        "Resolution": 0,
        "MeshExternal": false
    },
    {
        "Attributes": {
            "ServiceRegistry": "Kubernetes",
            "Name": "zipkin",
            "Namespace": "istio-system",
            "Labels": {
                "name": "zipkin"
            },
            "UID": "istio://istio-system/services/zipkin",
            "ExportTo": null,
            "LabelSelectors": {
                "app": "jaeger"
            },
            "ClusterExternalAddresses": null,
            "ClusterExternalPorts": null
        },
        "ports": [
            {
                "name": "http-query",
                "port": 9411,
                "protocol": "HTTP"
            }
        ],
        "creationTime": "2021-08-17T07:02:15Z",
        "hostname": "zipkin.istio-system.svc.cluster.local",
        "address": "10.109.220.250",
        "Mutex": {},
        "cluster-vips": {
            "Kubernetes": "10.109.220.250"
        },
        "Resolution": 0,
        "MeshExternal": false
    },
    {
        "Attributes": {
            "ServiceRegistry": "Kubernetes",
            "Name": "zookeeper",
            "Namespace": "dubbo",
            "Labels": null,
            "UID": "istio://dubbo/services/zookeeper",
            "ExportTo": null,
            "LabelSelectors": {
                "app": "zookeeper"
            },
            "ClusterExternalAddresses": null,
            "ClusterExternalPorts": null
        },
        "ports": [
            {
                "name": "tcp",
                "port": 2181,
                "protocol": "TCP"
            }
        ],
        "creationTime": "2021-09-06T07:02:40Z",
        "hostname": "zookeeper.dubbo.svc.cluster.local",
        "address": "10.109.126.153",
        "Mutex": {},
        "cluster-vips": {
            "Kubernetes": "10.109.126.153"
        },
        "Resolution": 0,
        "MeshExternal": false
    }
]
```



```
curl http://127.0.0.1:15014/debug/endpointz
```



```
{
    "svc": "org.apache.dubbo.demo.demoservice:tcp-dubbo",
    "ep": [
      {
        "service": {
          "Attributes": {
            "ServiceRegistry": "External",
            "Name": "org.apache.dubbo.demo.demoservice",
            "Namespace": "dubbo",
            "Labels": {
              "manager": "aeraki",
              "registry": "dubbo2istio"
            },
            "UID": "",
            "ExportTo": null,
            "LabelSelectors": null,
            "ClusterExternalAddresses": null,
            "ClusterExternalPorts": null
          },
          "ports": [
            {
              "name": "tcp-dubbo",
              "port": 20880,
              "protocol": "TCP"
            }
          ],
          "creationTime": "2021-09-10T09:58:18Z",
          "hostname": "org.apache.dubbo.demo.demoservice",
          "address": "0.0.0.0",
          "Mutex": {},
          "Resolution": 0,
          "MeshExternal": false
        },
        "servicePort": {
          "name": "tcp-dubbo",
          "port": 20880,
          "protocol": "TCP"
        },
        "endpoint": {
          "Labels": {
            "anyhost": "true",
            "application": "dubbo-demo-api-provider",
            "default": "true",
            "deprecated": "false",
            "dubbo": "2.0.2",
            "dynamic": "true",
            "generic": "false",
            "interface": "org.apache.dubbo.demo.DemoService",
            "methods": "sayHello-sayHelloAsync",
            "pid": "43370",
            "registryName": "default",
            "release": "",
            "side": "provider",
            "timestamp": "1631256613614"
          },
          "Address": "172.17.198.27",
          "ServicePortName": "tcp-dubbo",
          "EnvoyEndpoint": null,
          "ServiceAccount": "spiffe://cluster.local/ns/dubbo/sa/default",
          "Network": "",
          "Locality": {
            "Label": "",
            "ClusterID": ""
          },
          "EndpointPort": 20880,
          "LbWeight": 0,
          "TLSMode": "istio",
          "Namespace": "",
          "WorkloadName": "",
          "HostName": "",
          "SubDomain": "",
          "TunnelAbility": 0
        }
      }
    ]
  }
```



执行命令：

```
curl http://127.0.0.1:15014/debug/configz
```



 

数据面的获取到eds信息

```
istio-proxy@istiod-56f8cc6cb5-xkg4m:/$ curl http://127.0.0.1:15014/debug/edsz?proxyID=dubbo-sample-consumer-5778c77995-bvpjw
```



```
[
  {
    "clusterName": "outbound|20880||org.apache.dubbo.demo.demoservice",
    "endpoints": [
      {
        "locality": {},
        "lbEndpoints": [
          {
            "endpoint": {
              "address": {
                "socketAddress": {
                  "address": "172.17.198.27",
                  "portValue": 20880
                }
              }
            },
            "metadata": {
              "filterMetadata": {
                "envoy.transport_socket_match": {
                  "tlsMode": "istio"
                },
                "istio": {
                  "workload": ";;;;"
                }
              }
            },
            "loadBalancingWeight": 1
          }
        ],
        "loadBalancingWeight": 1
      }
    ]
  },
  {
    "clusterName": "outbound|9080||ratings.default.svc.cluster.local",
    "endpoints": [
      {
        "locality": {},
        "lbEndpoints": [
          {
            "endpoint": {
              "address": {
                "socketAddress": {
                  "address": "172.17.0.13",
                  "portValue": 9080
                }
              }
            },
            "metadata": {
              "filterMetadata": {
                "envoy.transport_socket_match": {
                  "tlsMode": "istio"
                },
                "istio": {
                  "workload": "ratings-v1;default;ratings;v1;Kubernetes"
                }
              }
            },
            "loadBalancingWeight": 1
          }
        ],
        "loadBalancingWeight": 1
      }
    ]
  },
  {
    "clusterName": "outbound|9411||zipkin.istio-system.svc.cluster.local",
    "endpoints": [
      {
        "locality": {},
        "lbEndpoints": [
          {
            "endpoint": {
              "address": {
                "socketAddress": {
                  "address": "172.17.0.7",
                  "portValue": 9411
                }
              }
            },
            "metadata": {
              "filterMetadata": {
                "istio": {
                  "workload": "jaeger;istio-system;;;Kubernetes"
                }
              }
            },
            "loadBalancingWeight": 1
          }
        ],
        "loadBalancingWeight": 1
      }
    ]
  },
  {
    "clusterName": "outbound|16685||tracing.istio-system.svc.cluster.local",
    "endpoints": [
      {
        "locality": {},
        "lbEndpoints": [
          {
            "endpoint": {
              "address": {
                "socketAddress": {
                  "address": "172.17.0.7",
                  "portValue": 16685
                }
              }
            },
            "metadata": {
              "filterMetadata": {
                "istio": {
                  "workload": "jaeger;istio-system;;;Kubernetes"
                }
              }
            },
            "loadBalancingWeight": 1
          }
        ],
        "loadBalancingWeight": 1
      }
    ]
  },
  {
    "clusterName": "outbound|80||tracing.istio-system.svc.cluster.local",
    "endpoints": [
      {
        "locality": {},
        "lbEndpoints": [
          {
            "endpoint": {
              "address": {
                "socketAddress": {
                  "address": "172.17.0.7",
                  "portValue": 16686
                }
              }
            },
            "metadata": {
              "filterMetadata": {
                "istio": {
                  "workload": "jaeger;istio-system;;;Kubernetes"
                }
              }
            },
            "loadBalancingWeight": 1
          }
        ],
        "loadBalancingWeight": 1
      }
    ]
  },
  {
    "clusterName": "outbound|9411||jaeger-collector.istio-system.svc.cluster.local",
    "endpoints": [
      {
        "locality": {},
        "lbEndpoints": [
          {
            "endpoint": {
              "address": {
                "socketAddress": {
                  "address": "172.17.0.7",
                  "portValue": 9411
                }
              }
            },
            "metadata": {
              "filterMetadata": {
                "istio": {
                  "workload": "jaeger;istio-system;;;Kubernetes"
                }
              }
            },
            "loadBalancingWeight": 1
          }
        ],
        "loadBalancingWeight": 1
      }
    ]
  },
  {
    "clusterName": "outbound|14250||jaeger-collector.istio-system.svc.cluster.local",
    "endpoints": [
      {
        "locality": {},
        "lbEndpoints": [
          {
            "endpoint": {
              "address": {
                "socketAddress": {
                  "address": "172.17.0.7",
                  "portValue": 14250
                }
              }
            },
            "metadata": {
              "filterMetadata": {
                "istio": {
                  "workload": "jaeger;istio-system;;;Kubernetes"
                }
              }
            },
            "loadBalancingWeight": 1
          }
        ],
        "loadBalancingWeight": 1
      }
    ]
  },
  {
    "clusterName": "outbound|14268||jaeger-collector.istio-system.svc.cluster.local",
    "endpoints": [
      {
        "locality": {},
        "lbEndpoints": [
          {
            "endpoint": {
              "address": {
                "socketAddress": {
                  "address": "172.17.0.7",
                  "portValue": 14268
                }
              }
            },
            "metadata": {
              "filterMetadata": {
                "istio": {
                  "workload": "jaeger;istio-system;;;Kubernetes"
                }
              }
            },
            "loadBalancingWeight": 1
          }
        ],
        "loadBalancingWeight": 1
      }
    ]
  },
  {
    "clusterName": "outbound|9090||prometheus.istio-system.svc.cluster.local",
    "endpoints": [
      {
        "locality": {},
        "lbEndpoints": [
          {
            "endpoint": {
              "address": {
                "socketAddress": {
                  "address": "172.17.0.11",
                  "portValue": 9090
                }
              }
            },
            "metadata": {
              "filterMetadata": {
                "istio": {
                  "workload": "prometheus;istio-system;;;Kubernetes"
                }
              }
            },
            "loadBalancingWeight": 1
          }
        ],
        "loadBalancingWeight": 1
      }
    ]
  },
  {
    "clusterName": "outbound|9080||productpage.default.svc.cluster.local",
    "endpoints": [
      {
        "locality": {},
        "lbEndpoints": [
          {
            "endpoint": {
              "address": {
                "socketAddress": {
                  "address": "172.17.0.3",
                  "portValue": 9080
                }
              }
            },
            "metadata": {
              "filterMetadata": {
                "envoy.transport_socket_match": {
                  "tlsMode": "istio"
                },
                "istio": {
                  "workload": "productpage-v1;default;productpage;v1;Kubernetes"
                }
              }
            },
            "loadBalancingWeight": 1
          }
        ],
        "loadBalancingWeight": 1
      }
    ]
  },
  {
    "clusterName": "outbound|9080||details.default.svc.cluster.local",
    "endpoints": [
      {
        "locality": {},
        "lbEndpoints": [
          {
            "endpoint": {
              "address": {
                "socketAddress": {
                  "address": "172.17.0.20",
                  "portValue": 9080
                }
              }
            },
            "metadata": {
              "filterMetadata": {
                "envoy.transport_socket_match": {
                  "tlsMode": "istio"
                },
                "istio": {
                  "workload": "details-v1;default;details;v1;Kubernetes"
                }
              }
            },
            "loadBalancingWeight": 1
          }
        ],
        "loadBalancingWeight": 1
      }
    ]
  },
  {
    "clusterName": "outbound|9080||reviews.default.svc.cluster.local",
    "endpoints": [
      {
        "locality": {},
        "lbEndpoints": [
          {
            "endpoint": {
              "address": {
                "socketAddress": {
                  "address": "172.17.0.12",
                  "portValue": 9080
                }
              }
            },
            "metadata": {
              "filterMetadata": {
                "envoy.transport_socket_match": {
                  "tlsMode": "istio"
                },
                "istio": {
                  "workload": "reviews-v2;default;reviews;v2;Kubernetes"
                }
              }
            },
            "loadBalancingWeight": 1
          },
          {
            "endpoint": {
              "address": {
                "socketAddress": {
                  "address": "172.17.0.6",
                  "portValue": 9080
                }
              }
            },
            "metadata": {
              "filterMetadata": {
                "envoy.transport_socket_match": {
                  "tlsMode": "istio"
                },
                "istio": {
                  "workload": "reviews-v3;default;reviews;v3;Kubernetes"
                }
              }
            },
            "loadBalancingWeight": 1
          },
          {
            "endpoint": {
              "address": {
                "socketAddress": {
                  "address": "172.17.0.9",
                  "portValue": 9080
                }
              }
            },
            "metadata": {
              "filterMetadata": {
                "envoy.transport_socket_match": {
                  "tlsMode": "istio"
                },
                "istio": {
                  "workload": "reviews-v1;default;reviews;v1;Kubernetes"
                }
              }
            },
            "loadBalancingWeight": 1
          }
        ],
        "loadBalancingWeight": 3
      }
    ]
  },
  {
    "clusterName": "outbound|9090||kiali.istio-system.svc.cluster.local",
    "endpoints": [
      {
        "locality": {},
        "lbEndpoints": [
          {
            "endpoint": {
              "address": {
                "socketAddress": {
                  "address": "172.17.0.10",
                  "portValue": 9090
                }
              }
            },
            "metadata": {
              "filterMetadata": {
                "istio": {
                  "workload": "kiali;istio-system;;;Kubernetes"
                }
              }
            },
            "loadBalancingWeight": 1
          }
        ],
        "loadBalancingWeight": 1
      }
    ]
  },
  {
    "clusterName": "outbound|20001||kiali.istio-system.svc.cluster.local",
    "endpoints": [
      {
        "locality": {},
        "lbEndpoints": [
          {
            "endpoint": {
              "address": {
                "socketAddress": {
                  "address": "172.17.0.10",
                  "portValue": 20001
                }
              }
            },
            "metadata": {
              "filterMetadata": {
                "istio": {
                  "workload": "kiali;istio-system;;;Kubernetes"
                }
              }
            },
            "loadBalancingWeight": 1
          }
        ],
        "loadBalancingWeight": 1
      }
    ]
  },
  {
    "clusterName": "outbound|443||istio-ingressgateway.istio-system.svc.cluster.local",
    "endpoints": [
      {
        "locality": {},
        "lbEndpoints": [
          {
            "endpoint": {
              "address": {
                "socketAddress": {
                  "address": "172.17.0.4",
                  "portValue": 8443
                }
              }
            },
            "metadata": {
              "filterMetadata": {
                "istio": {
                  "workload": "istio-ingressgateway;istio-system;istio-ingressgateway;latest;Kubernetes"
                }
              }
            },
            "loadBalancingWeight": 1
          }
        ],
        "loadBalancingWeight": 1
      }
    ]
  },
  {
    "clusterName": "outbound|80||istio-ingressgateway.istio-system.svc.cluster.local",
    "endpoints": [
      {
        "locality": {},
        "lbEndpoints": [
          {
            "endpoint": {
              "address": {
                "socketAddress": {
                  "address": "172.17.0.4",
                  "portValue": 8080
                }
              }
            },
            "metadata": {
              "filterMetadata": {
                "istio": {
                  "workload": "istio-ingressgateway;istio-system;istio-ingressgateway;latest;Kubernetes"
                }
              }
            },
            "loadBalancingWeight": 1
          }
        ],
        "loadBalancingWeight": 1
      }
    ]
  },
  {
    "clusterName": "outbound|15021||istio-ingressgateway.istio-system.svc.cluster.local",
    "endpoints": [
      {
        "locality": {},
        "lbEndpoints": [
          {
            "endpoint": {
              "address": {
                "socketAddress": {
                  "address": "172.17.0.4",
                  "portValue": 15021
                }
              }
            },
            "metadata": {
              "filterMetadata": {
                "istio": {
                  "workload": "istio-ingressgateway;istio-system;istio-ingressgateway;latest;Kubernetes"
                }
              }
            },
            "loadBalancingWeight": 1
          }
        ],
        "loadBalancingWeight": 1
      }
    ]
  },
  {
    "clusterName": "outbound|15012||istiod.istio-system.svc.cluster.local",
    "endpoints": [
      {
        "locality": {},
        "lbEndpoints": [
          {
            "endpoint": {
              "address": {
                "socketAddress": {
                  "address": "172.17.0.21",
                  "portValue": 15012
                }
              }
            },
            "metadata": {
              "filterMetadata": {
                "istio": {
                  "workload": "istiod;istio-system;;;Kubernetes"
                }
              }
            },
            "loadBalancingWeight": 1
          }
        ],
        "loadBalancingWeight": 1
      }
    ]
  },
  {
    "clusterName": "outbound|53||kube-dns.kube-system.svc.cluster.local",
    "endpoints": [
      {
        "locality": {},
        "lbEndpoints": [
          {
            "endpoint": {
              "address": {
                "socketAddress": {
                  "address": "172.17.0.16",
                  "portValue": 53
                }
              }
            },
            "metadata": {
              "filterMetadata": {
                "istio": {
                  "workload": "coredns;kube-system;;;Kubernetes"
                }
              }
            },
            "loadBalancingWeight": 1
          }
        ],
        "loadBalancingWeight": 1
      }
    ]
  },
  {
    "clusterName": "outbound|15010||istiod.istio-system.svc.cluster.local",
    "endpoints": [
      {
        "locality": {},
        "lbEndpoints": [
          {
            "endpoint": {
              "address": {
                "socketAddress": {
                  "address": "172.17.0.21",
                  "portValue": 15010
                }
              }
            },
            "metadata": {
              "filterMetadata": {
                "istio": {
                  "workload": "istiod;istio-system;;;Kubernetes"
                }
              }
            },
            "loadBalancingWeight": 1
          }
        ],
        "loadBalancingWeight": 1
      }
    ]
  },
  {
    "clusterName": "outbound|9153||kube-dns.kube-system.svc.cluster.local",
    "endpoints": [
      {
        "locality": {},
        "lbEndpoints": [
          {
            "endpoint": {
              "address": {
                "socketAddress": {
                  "address": "172.17.0.16",
                  "portValue": 9153
                }
              }
            },
            "metadata": {
              "filterMetadata": {
                "istio": {
                  "workload": "coredns;kube-system;;;Kubernetes"
                }
              }
            },
            "loadBalancingWeight": 1
          }
        ],
        "loadBalancingWeight": 1
      }
    ]
  },
  {
    "clusterName": "outbound|20880||org.apache.dubbo.samples.basic.api.testservice",
    "endpoints": [
      {
        "locality": {
          "region": "bj",
          "zone": "800002"
        },
        "lbEndpoints": [
          {
            "endpoint": {
              "address": {
                "socketAddress": {
                  "address": "172.17.0.17",
                  "portValue": 20880
                }
              }
            },
            "metadata": {
              "filterMetadata": {
                "envoy.transport_socket_match": {
                  "tlsMode": "istio"
                },
                "istio": {
                  "workload": ";;;;"
                }
              }
            },
            "loadBalancingWeight": 1
          }
        ],
        "loadBalancingWeight": 1
      },
      {
        "locality": {
          "region": "bj",
          "zone": "800005"
        },
        "lbEndpoints": [
          {
            "endpoint": {
              "address": {
                "socketAddress": {
                  "address": "172.17.0.19",
                  "portValue": 20880
                }
              }
            },
            "metadata": {
              "filterMetadata": {
                "envoy.transport_socket_match": {
                  "tlsMode": "istio"
                },
                "istio": {
                  "workload": ";;;;"
                }
              }
            },
            "loadBalancingWeight": 1
          }
        ],
        "loadBalancingWeight": 1
      }
    ]
  },
  {
    "clusterName": "outbound|443||kubernetes.default.svc.cluster.local",
    "endpoints": [
      {
        "locality": {},
        "lbEndpoints": [
          {
            "endpoint": {
              "address": {
                "socketAddress": {
                  "address": "192.168.49.2",
                  "portValue": 8443
                }
              }
            },
            "metadata": {
              "filterMetadata": {
                "istio": {
                  "workload": ";;;;Kubernetes"
                }
              }
            },
            "loadBalancingWeight": 1
          }
        ],
        "loadBalancingWeight": 1
      }
    ]
  },
  {
    "clusterName": "outbound|20880||org.apache.dubbo.samples.basic.api.complexservice-test-1-0-0",
    "endpoints": [
      {
        "locality": {
          "region": "bj",
          "zone": "800002"
        },
        "lbEndpoints": [
          {
            "endpoint": {
              "address": {
                "socketAddress": {
                  "address": "172.17.0.17",
                  "portValue": 20880
                }
              }
            },
            "metadata": {
              "filterMetadata": {
                "envoy.transport_socket_match": {
                  "tlsMode": "istio"
                },
                "istio": {
                  "workload": ";;;;"
                }
              }
            },
            "loadBalancingWeight": 1
          }
        ],
        "loadBalancingWeight": 1
      },
      {
        "locality": {
          "region": "bj",
          "zone": "800005"
        },
        "lbEndpoints": [
          {
            "endpoint": {
              "address": {
                "socketAddress": {
                  "address": "172.17.0.19",
                  "portValue": 20880
                }
              }
            },
            "metadata": {
              "filterMetadata": {
                "envoy.transport_socket_match": {
                  "tlsMode": "istio"
                },
                "istio": {
                  "workload": ";;;;"
                }
              }
            },
            "loadBalancingWeight": 1
          }
        ],
        "loadBalancingWeight": 1
      }
    ]
  },
  {
    "clusterName": "outbound|2181||zookeeper.dubbo.svc.cluster.local",
    "endpoints": [
      {
        "locality": {},
        "lbEndpoints": [
          {
            "endpoint": {
              "address": {
                "socketAddress": {
                  "address": "172.17.0.14",
                  "portValue": 2181
                }
              }
            },
            "metadata": {
              "filterMetadata": {
                "envoy.transport_socket_match": {
                  "tlsMode": "istio"
                },
                "istio": {
                  "workload": "zookeeper;dubbo;zookeeper;latest;Kubernetes"
                }
              }
            },
            "loadBalancingWeight": 1
          }
        ],
        "loadBalancingWeight": 1
      }
    ]
  },
  {
    "clusterName": "outbound|20880||org.apache.dubbo.samples.basic.api.demoservice",
    "endpoints": [
      {
        "locality": {
          "region": "bj",
          "zone": "800002"
        },
        "lbEndpoints": [
          {
            "endpoint": {
              "address": {
                "socketAddress": {
                  "address": "172.17.0.17",
                  "portValue": 20880
                }
              }
            },
            "metadata": {
              "filterMetadata": {
                "envoy.transport_socket_match": {
                  "tlsMode": "istio"
                },
                "istio": {
                  "workload": ";;;;"
                }
              }
            },
            "loadBalancingWeight": 1
          }
        ],
        "loadBalancingWeight": 1
      },
      {
        "locality": {
          "region": "bj",
          "zone": "800005"
        },
        "lbEndpoints": [
          {
            "endpoint": {
              "address": {
                "socketAddress": {
                  "address": "172.17.0.19",
                  "portValue": 20880
                }
              }
            },
            "metadata": {
              "filterMetadata": {
                "envoy.transport_socket_match": {
                  "tlsMode": "istio"
                },
                "istio": {
                  "workload": ";;;;"
                }
              }
            },
            "loadBalancingWeight": 1
          }
        ],
        "loadBalancingWeight": 1
      }
    ]
  },
  {
    "clusterName": "outbound|443||istiod.istio-system.svc.cluster.local",
    "endpoints": [
      {
        "locality": {},
        "lbEndpoints": [
          {
            "endpoint": {
              "address": {
                "socketAddress": {
                  "address": "172.17.0.21",
                  "portValue": 15017
                }
              }
            },
            "metadata": {
              "filterMetadata": {
                "istio": {
                  "workload": "istiod;istio-system;;;Kubernetes"
                }
              }
            },
            "loadBalancingWeight": 1
          }
        ],
        "loadBalancingWeight": 1
      }
    ]
  },
  {
    "clusterName": "outbound|20880||org.apache.dubbo.samples.basic.api.complexservice-product-2-0-0",
    "endpoints": [
      {
        "locality": {
          "region": "bj",
          "zone": "800002"
        },
        "lbEndpoints": [
          {
            "endpoint": {
              "address": {
                "socketAddress": {
                  "address": "172.17.0.17",
                  "portValue": 20880
                }
              }
            },
            "metadata": {
              "filterMetadata": {
                "envoy.transport_socket_match": {
                  "tlsMode": "istio"
                },
                "istio": {
                  "workload": ";;;;"
                }
              }
            },
            "loadBalancingWeight": 1
          }
        ],
        "loadBalancingWeight": 1
      },
      {
        "locality": {
          "region": "bj",
          "zone": "800005"
        },
        "lbEndpoints": [
          {
            "endpoint": {
              "address": {
                "socketAddress": {
                  "address": "172.17.0.19",
                  "portValue": 20880
                }
              }
            },
            "metadata": {
              "filterMetadata": {
                "envoy.transport_socket_match": {
                  "tlsMode": "istio"
                },
                "istio": {
                  "workload": ";;;;"
                }
              }
            },
            "loadBalancingWeight": 1
          }
        ],
        "loadBalancingWeight": 1
      }
    ]
  },
  {
    "clusterName": "outbound|3000||grafana.istio-system.svc.cluster.local",
    "endpoints": [
      {
        "locality": {},
        "lbEndpoints": [
          {
            "endpoint": {
              "address": {
                "socketAddress": {
                  "address": "172.17.0.2",
                  "portValue": 3000
                }
              }
            },
            "metadata": {
              "filterMetadata": {
                "istio": {
                  "workload": "grafana;istio-system;;;Kubernetes"
                }
              }
            },
            "loadBalancingWeight": 1
          }
        ],
        "loadBalancingWeight": 1
      }
    ]
  },
  {
    "clusterName": "outbound|15014||istiod.istio-system.svc.cluster.local",
    "endpoints": [
      {
        "locality": {},
        "lbEndpoints": [
          {
            "endpoint": {
              "address": {
                "socketAddress": {
                  "address": "172.17.0.21",
                  "portValue": 15014
                }
              }
            },
            "metadata": {
              "filterMetadata": {
                "istio": {
                  "workload": "istiod;istio-system;;;Kubernetes"
                }
              }
            },
            "loadBalancingWeight": 1
          }
        ],
        "loadBalancingWeight": 1
      }
    ]
  }
]
```



进入pod的数据面docker

```
kubectl -n dubbo exec -it dubbo-sample-consumer-5778c77995-bvpjw --container istio-proxy -- /bin/bash
```



进入主容器（业务docker）

```
kubectl -n dubbo exec -it dubbo-sample-consumer-5778c77995-bvpjw -- /bin/bash
```





